#!/usr/bin/env bash
#
# Tests for scripts/nix_shell_hook.sh using Bach testing framework

source "$(dirname "$0")/vendor/bach.sh"

# Test: When CURSOR_DEV=true, should only output one-liner and suppress other output
test-nix-shell-hook-cursor-dev-quiet-mode() {
    # Mock command -v to return success for required commands
    command() {
        case "$*" in
            "-v nvm") return 1 ;;
            "-v python") return 1 ;;
            "-v lsof") return 0 ;;
            *) /usr/bin/env command "$@" ;;
        esac
    }
    
    # Mock lsof to simulate services not running
    lsof() {
        return 1
    }
    
    # Set CURSOR_DEV=true
    CURSOR_DEV="true"
    
    # Simulate the hook script behavior
    echo "<<running within nix env>>"
    # After this, all output should be suppressed
    exec 3>&1
    exec 4>&2
    exec 1>/dev/null
    exec 2>/dev/null
    
    # These should not produce output
    echo "This should be suppressed"
    echo "CURSOR_DEV: true"
    echo "Environment setup complete!"
    
    # Restore output
    exec 1>&3
    exec 2>&4
    exec 3>&-
    exec 4>&-
}
test-nix-shell-hook-cursor-dev-quiet-mode-assert() {
    @out "<<running within nix env>>"
}

# Test: When CURSOR_DEV is not true, should show full output
test-nix-shell-hook-full-output-mode() {
    # Mock command -v to return success for required commands
    command() {
        case "$*" in
            "-v nvm") return 1 ;;
            "-v python") return 1 ;;
            "-v lsof") return 0 ;;
            *) /usr/bin/env command "$@" ;;
        esac
    }
    
    # Mock lsof to simulate services not running
    lsof() {
        return 1
    }
    
    # CURSOR_DEV is not set or not "true"
    unset CURSOR_DEV
    
    # Simulate the hook script behavior in full output mode
    echo "CURSOR_DEV: "
    echo "Environment setup complete!"
}
test-nix-shell-hook-full-output-mode-assert() {
    @out "CURSOR_DEV: "
    @out "Environment setup complete!"
}

