---
description: How to setup dev env on Cursor Cloud Agent with Cloud VM
alwaysApply: true
---

# Cloud VM Development Environment Setup

**CRITICAL: On Cloud VM, the `CURSOR_DEV=true nix develop -c` prefix MUST NOT be added to commands. Run commands directly without any nix prefix.**

## When to Use This Rule

**Use this rule when:**
- Setting up development environment on Cursor Cloud VM
- Running tests (frontend, backend, e2e) on Cloud VM
- Executing terminal commands on Cloud VM
- Encountering command execution errors on Cloud VM

## Environment Setup

**Pre-configured environment:**
- **Node.js**: v22.21.1 ✅ (meets project requirement: >=22)
- **pnpm**: 10.22.0 ✅ (meets project requirement: >=10.22.0)
- **No nix**: Not available (nor needed)

**Command execution:** Run commands **DIRECTLY** without nix prefix

## One-Time Setup for Backend and E2E Tests

For backend and e2e tests, you need to set up Java and MySQL:

```bash
# One-time setup (installs Java 25 and MySQL)
source /workspace/scripts/cloud_agent_setup.sh
```

This script:
- Downloads and installs Azul Zulu Java 25 (required by the project)
- Downloads and sets up MySQL 8.4 server
- Initializes doughnut test databases (doughnut_test, doughnut_development, doughnut_e2e_test)
- Exports necessary environment variables (JAVA_HOME, MYSQL_HOME, SPRING_DATASOURCE_*, INPUT_DB_URL)

**Environment Details**:
- Java 25 installed to: `/tmp/java25/zulu25.30.17-ca-jdk25.0.1-linux_x64`
- MySQL installed to: `/tmp/mysql-8.4.3-linux-glibc2.28-x86_64`
- MySQL data directory: `/tmp/mysql_data`
- MySQL socket: `/tmp/mysql.sock`
- MySQL port: 3306
- **INPUT_DB_URL**: Set to `jdbc:mysql://localhost:3306/doughnut_e2e_test?allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true` for e2e tests

**Note**: The setup script is idempotent and can be run multiple times safely. It will skip steps that are already completed.

## Running Tests

### Frontend Unit Tests

```bash
pnpm frontend:test
```

### Backend Unit Tests

```bash
# One-time setup (if not already done)
source /workspace/scripts/cloud_agent_setup.sh

# Run database migration (required before first test run or after schema changes)
./backend/gradlew -p backend migrateTestDB -Dspring.profiles.active=test

# Run tests
./backend/gradlew -p backend test -Dspring.profiles.active=test --build-cache --parallel
```

### E2E Tests

```bash
# One-time setup (if not already done) - sets up MySQL and exports INPUT_DB_URL
source /workspace/scripts/cloud_agent_setup.sh

# Start services in the background (only needed for e2e tests)
# The setup script exports INPUT_DB_URL which the backend uses when running with e2e profile
pnpm sut &

# Wait 10 seconds for services to be ready
sleep 10

# Run tests
pnpm cypress run --spec e2e_test/features/<feature-file>.feature
```

**Note**: The backend runs on port **9081** and frontend on port **5173**. The setup script exports `INPUT_DB_URL` which tells the backend (when using e2e profile) to use the `doughnut_e2e_test` database on port 3306.

## Key Rules

1. **Do NOT use `CURSOR_DEV=true nix develop -c` prefix** - run commands directly
2. **Backend tests:** Require one-time setup script for Java and MySQL
3. **E2E tests:** **MUST source the setup script first** (to set INPUT_DB_URL), **then start `pnpm sut` in the background, wait 10 seconds, then run tests** (only needed for e2e tests, not for unit tests)
4. **Service ports:** Backend runs on **9081**, frontend on **5173**
5. **Test execution:** Frontend tests work without nix
6. **Linting errors:** TypeScript/vue-tsc errors may appear but don't prevent test execution

## Common Commands Reference

| Command | Cloud VM |
|---------|----------|
| Frontend tests | `pnpm frontend:test` |
| Backend tests | `pnpm backend:verify` |
| E2E tests | `pnpm sut &` then `sleep 10` then `pnpm cypress run --spec <path>` |
| Linting | `pnpm lint:all` |
| Formatting | `pnpm format:all` |
