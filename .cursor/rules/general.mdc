---
description:
globs:
alwaysApply: true
---

# The use of nix

**CRITICAL: This project uses nix to manage the development environment locally. For Cloud Agent, see the later instructions**

**YOU MUST ALWAYS prefix commands with `CURSOR_DEV=true` when running them through `nix develop -c` (When running as a local agent):**

```bash
CURSOR_DEV=true nix develop -c <command>
```

# Development Environment Setup

## Starting the Development Environment

**IMPORTANT**: Always assume that the developer has already started all necessary services using:

```bash
pnpm sut
```

This command starts:
- Backend (with auto-reload on Java code changes via Gradle continuous build)
- Frontend (with hot module replacement on Vue code changes)
- Mountebank (mock external services)

**CRITICAL: All services automatically restart/reload when code changes are made.**

**DO NOT tell developers to restart `pnpm sut` after making code changes!** 
- Backend: Uses Gradle continuous build (`-t` flag) which automatically detects changes, recompiles Java classes, and hot-reloads them into the running Spring Boot application
- Frontend: Uses Vite with Hot Module Replacement (HMR) for instant Vue component updates
- Developers should NEVER need to manually restart services during development

**If services are not running or if you need to suggest starting them**, recommend running `pnpm sut` in a separate terminal first. But once running, DO NOT suggest restarting after code changes.

## Running Commands in Terminal

### For Cloud Agents (Cursor Background Agent)

**Cloud agents run in a pre-configured virtual machine with the correct Node.js and pnpm versions already installed.**

The cloud environment includes:
- Node.js v22.21.1
- pnpm 10.22.0

**Cloud agents should run commands DIRECTLY without nix:**

#### Running Tests on Cloud Agent

**Frontend unit test:**
```bash
pnpm frontend:test
```

**Backend unit test:**
```bash
pnpm backend:verify
```

**E2E test** (assumes services are already running):
```bash
pnpm cypress run --spec e2e_test/features/ai_generated_recall_questions/question_contest.feature
```

**Note:** Cloud agents do NOT need the `CURSOR_DEV=true nix develop -c` prefix.

#### Running Tests for Local Development

**Backend unit test:**
```bash
CURSOR_DEV=true nix develop -c pnpm backend:verify
```

**Frontend unit test:**
```bash
CURSOR_DEV=true nix develop -c pnpm frontend:test
```

**E2E test** (assumes services are already running via `pnpm sut`):
```bash
CURSOR_DEV=true nix develop -c pnpm cypress run --spec e2e_test/features/ai_generated_recall_questions/question_contest.feature
```

**Note:** ALL commands in local development that need to run in the nix development environment MUST use `CURSOR_DEV=true nix develop -c` prefix.

# Development preferences

## High Cohesion

It is the top priority to keep high cohesion all the time.

* Minimize the duplicate and make sure the same concept has one representation acroess the whole system
* The code should have good mapping to the ubiquitous business domain
* Thing belong together should be placed together or close by, so that they are easy to use

## Keep it simple

* DO NOT follow the defensive programming style
* Use the simplest solution and minimum code to achieve what the prompt asked to do.

## Documentation

* DO NOT add historical documentation, comments about past implementations, or completed task lists
* Code readers only care about the current state, not development history
* Exception: Temporary requirement documents in the `ongoing/` folder are allowed for active development
